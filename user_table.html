<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="Fulfillment database">
        <meta name="author" content="Urban Launchpad / Daniel Palencia">
        <!-- Script for accessing the Fusion Tables database. -->
        <script type="text/javascript" src="http://www.google.com/jsapi"></script>  
        <!-- Script for Swiper library by iDangero.us -->
        <link rel="stylesheet" href="style/idangerous.swiper.css">
        <script defer src="script/idangerous.swiper-2.x.min.js"></script>
        <script type="text/javascript">
            google.load('visualization', '1', {packages: ['corechart']});
            var mainDatabaseFusionTableID = "1WgAjYadEjbBf_PJbFh6_GPMdL9jum6pIKs1WSAZ-"; // Table with product tracking info.
            var columnNames = ["GARMENT_NAME", "GARMENT_CODE", "STEP_NUM", "STEP_DESC", "ACTOR", "HASHTAG", "LOCATION", "LOCATION_GPS", "HANDS", "START_DATE", "COMPLETE_DATE", "DURATION_DAYS", "COST_USD", "IMAGE"];
            var stepsToShow;
            var infoToShowKeys;
            var whatToGet;
            var stepsArray;

            function initialize(){
                stepsToShow = getStepsToShow();
                infoToShowKeys = getInfoToShow();
                whatToGet = getWhatToGet();
                textileCodes = getTextileParsingCodes();
            }

            function getStepsToShow(){
                var stepsToShow = ["Fiber", "Design","Textile_Production", "Garment_Production", "Distribution"];
                return stepsToShow;
            }

            function getInfoToShow(){
                var infoToShowKeys = ["In_Charge", "Location", "Time", "Hands"];
                return infoToShowKeys;
            }

            function getTextileParsingCodes(){
                var textileCodes = ["kot","mir","dha"]
                return textileCodes;
            }

            function getWhatToGet(){
                var whatToGet = "";
                for (var i = 0; i < columnNames.length; i++){
                    whatToGet = whatToGet + columnNames[i] + ", ";
                }
                whatToGet = whatToGet.substring(0, whatToGet.length - 2);
                return whatToGet;
            }

            function getGarmentInfo(key, whatToGet){
                var ShirtInfoPromise = new Promise(function(resolve, reject) {
                    // do a thing, possibly async, thenâ€¦
                    var queryString = "SELECT " + whatToGet + " FROM " + mainDatabaseFusionTableID + " WHERE GARMENT_CODE = '" + key.garment_Code + "'";
                    var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq=' + encodeURIComponent(queryString));   
                    query.send(function (response){
                        var table = response.getDataTable();
                        var rows = table.getNumberOfRows();
                        var info = new Array(stepsToShow.length);
                        var k = 0;
                        // Creating an array with all the steps storead as objects with the information in them storead with the column names as field names.
                        stepsArray = new Array(rows);
                        for (var j=0; j < rows; j++){
                            stepsArray[j] = {};
                            for (var i=0; i < columnNames.length; i++){
                                stepsArray[j][columnNames[i]] = table.getValue(j,i);
                            }
                        }
                    if (stepsArray.length > 0) {
                        resolve("Stuff worked!");
                    }
                    else {
                        reject(Error("It broke"));
                    }

                    });

                });
                return ShirtInfoPromise;
            }

            function fillCards(stepsArray){
                var swiperWrapper = document.getElementById("swiper-wrapper");
                for (var i=0; i < stepsArray.length; i++){
                    var swiperSlide = document.createElement('div');
                    swiperSlide.className = 'swiper-slide';
                    var title = document.createTextNode(stepsArray[i].STEP_DESC);
                    swiperSlide.appendChild(title);

                    var title = document.createTextNode(stepsArray[i].STEP_NUM);
                    swiperSlide.appendChild(title);

                    var Img=document.createElement("img");
                    Img.setAttribute('src', stepsArray[i].IMAGE);
                    swiperSlide.appendChild(Img);                  



                  swiperWrapper.appendChild(swiperSlide); 
                }
                createSwiperInterface();
            }

            // TODO Add parsing function for the key.
            function parseKey(key){
                var isKeyOK = true;
                return isKeyOK;
            }
            function getKeyFromForm(){
                var productionKey = document.getElementById("production").value.toUpperCase();
                var fulfillmentKey = document.getElementById("fulfillment").value.toUpperCase();
                var key = {
                    garment_Code : productionKey,
                    textile : productionKey.substring(0,3),
                    style : productionKey.substring(3,6),
                    design_Batch : productionKey.substring(6,9),
                    size : fulfillmentKey.substring(0,0),
                    unique_ID : fulfillmentKey.substring(1,4),
                };
                return key;
            }
            function onShowButtonClick(){
                document.getElementById("inputContainer").style.display="none";
                var key = getKeyFromForm();
                if (parseKey(key)) {
                    var shirtInfoPromise = getGarmentInfo(key, whatToGet);
                    shirtInfoPromise.then(function(result) {
                        console.log(result); // "Stuff worked!"
                        alert("SEEEEEEE HOLA");
                        getActorInfo();
                        fillCards(stepsArray);
                    }, function(err) {
                        console.log(err); // Error: "It broke"
                        showError("SHIRT_INFO_ERROR")
                    });
                }
                document.getElementById("cardContainer").style.display="block";
            }

            function getActorInfo(){


            }

            function showError(error){
                alert(error)
            }

            function createSwiperInterface() {
                var mySwiper = new Swiper('.swiper-container',{
                    //Your options here:
                    mode:'horizontal',
                    pagination: '.pagination',
                    paginationClickable: true,
                    loop: true,
                    grabCursor: true,
                    createPagination: true,
                    autoResize: true,
                    resizeReInit: true,
                    //etc..
                });
            }
        </script>  
        <style>
            html {height: 100%;}
            body {height: 100%;}
            .swiper-container{min-height: 100%;}
            .pagination{position:absolute;z-index:20;left:10px;bottom:10px;}
            .swiper-pagination-switch{display:inline-block;width:8px;height:8px;border-radius:8px;background:#222;margin-right:5px;opacity:0.8;border:1px solid #fff;cursor:pointer;}
            .swiper-visible-switch{background:#aaa;}
            .swiper-active-switch{background:#fff;}

        </style>
    </head>
    <body role="document" onload="initialize()">
        <div id="inputContainer">
            <div style="background-image: url(img/tag.jpg); height: 240px; width: 370px">
                <div style="position: relative; top: 200px">
                    <div style="width: 170px; margin-left: auto; margin-right: auto">    
                        <input type="text" name="production" id="production" size="9" maxlength="9">
                        <input type="text" name="fulfillment" id="fulfillment" size="4" maxlength="4">
                    </div>    
                </div>
            </div>
            <input type="button" value="Submit" onclick="onShowButtonClick()">
        </div>
        <div class="swiper-container" id="cardContainer" style="display:none">
            <div class="swiper-wrapper" id="swiper-wrapper">
        </div>
        <div class="pagination"></div>
        </div>
    </body>
</html>