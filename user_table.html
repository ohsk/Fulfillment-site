<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">
        <script type="text/javascript" src="http://www.google.com/jsapi"></script>   
        <script type="text/javascript">
            google.load('visualization', '1', {packages: ['corechart']});
            var mainDatabaseFusionTableID = "1OIi7vxHHfNYOCk_8kTnVMqZrw4hF7VlTxLsxPz-O"; // Table with product tracking info.
            var whatToGetFusionTableID = "1bm8y6K3bFzpbdRZLtV5VPZrNcXuuj1mjle-4-7de"; // Table with the list of items to be pulled from the main database to be shown on the product information table.
            var stepsToShow;
            var infoToShowKeys;
            var whatToGet;

            function initialize(){
                stepsToShow = getStepsToShow();
                infoToShowKeys = getInfoToShow();
                whatToGet = getWhatToGet();
                textileCodes = getTextileParsingCodes();
            }

            function getStepsToShow(){
                var stepsToShow = ["Fiber", "Design","Textile_Production", "Garment_Production", "Distribution"];
                return stepsToShow;
            }

            function getInfoToShow(){
                var infoToShowKeys = ["In_Charge", "Location", "Time", "Hands"];
                return infoToShowKeys;
            }

            function getTextileParsingCodes(){
                var textileCodes = ["kot","mir","dha"]
                return textileCodes;
            }

            function getWhatToGet(){
                var whatToGet = "";
                for (var i = 0; i < stepsToShow.length; i++){
                    for (var j = 0; j < infoToShowKeys.length; j++){
                        whatToGet = whatToGet + stepsToShow[i] + "_" + infoToShowKeys[j] + ", ";
                    }
                }
                whatToGet = whatToGet.substring(0, whatToGet.length - 2);
                return whatToGet;
            }

            function getShirtInfo(key, whatToGet){
                var queryString = "SELECT " + whatToGet + " FROM " + mainDatabaseFusionTableID + " WHERE Design_Batch = '" + key.design_Batch + "' AND Start_ID <= " + key.unique_ID + " AND End_ID >= " + key.unique_ID + "";
                var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq=' + encodeURIComponent(queryString));   
                query.send(function (response){
                        var table = response.getDataTable();
                        var rows = table.getNumberOfRows();
                        var info = new Array(stepsToShow.length);
                        var k = 0;

                        // Creating a table with the information of the garments. i is the steps dimension and j the details dimension.
                        for (var i = 0; i < stepsToShow.length; i++) {
                            info[i] = new Array(infoToShowKeys.length);
                            for (var j = 0; j < infoToShowKeys.length; j++){
                                info[i][j] = table.getValue(0,k);
                                //alert(info[i][j]);
                                k++;
                            }
                        }
                        fillTable(stepsToShow, "infoToshow", info);
                });
                //return table;
            }
            // TODO Add parsing function for the key.
            function parseKey(key){
                var isKeyOK = true;
/*                if (textileCodes.indexof(key) >= 0){
                    isKeyOK = true;
                }

                if (!isKeyOK){
                    showParseError();
                }*/
                return isKeyOK;
            }
            function getKeyFromForm(){
                var productionKey = document.getElementById("production").value;
                var fulfillmentKey = document.getElementById("fulfillment").value;
                var key = {
                    textile : productionKey.substring(0,3),
                    style : productionKey.substring(3,6),
                    design_Batch : productionKey.substring(6,9),
                    size : fulfillmentKey.substring(0,0),
                    unique_ID : fulfillmentKey.substring(1,4),
                };
                alert(key.design_Batch);
                return key;
            }
            function onShowButtonClick(){
                var key = getKeyFromForm();
                if (parseKey(key)) {
                    var info = getShirtInfo(key, whatToGet);
                }
            }
            function showParseError(){
                alert("The ID you've entered doesn't match any of our garments. Please try again!")
            }
            function fillTable(stepsToShow, infoToshow, info){
                infoToshow = ["Process", "In charge", "Location", "Time", "Number of hands"]

                var tableHead = document.getElementById("garment_info_table_head");
                tableHead.removeChild(tableHead.firstChild);        
                var headRow = document.createElement("tr");
                for(var i = 0; i < infoToshow.length; i++){
                    var cell = document.createElement("td");
                    var textnode = document.createTextNode(infoToshow[i]);
                    cell.appendChild(textnode);
                    headRow.appendChild(cell);
                }
                tableHead.appendChild(headRow);

                var tableBody = document.getElementById("garment_info_table_body");
                for(var i = 0; i < stepsToShow.length; i++){
                    var row = document.createElement("tr");
                    for(var j = 0; j < infoToshow.length; j++){ 
                        var cell = document.createElement("td");
                        if (j == 0){
                            var textnode = document.createTextNode(stepsToShow[i]);
                        } else {
                            var textnode = document.createTextNode(info[i][j-1]);
                        }
                        cell.appendChild(textnode);
                        row.appendChild(cell);
                    }
                    tableBody.appendChild(row);
                }

            }
        </script>     
    </head>
    <body role="document" onload="initialize()">
        <div style="background-image: url(img/tag.jpg); height: 240px; width: 370px">
            <div style="position: relative; top: 200px">
                <div style="width: 170px; margin-left: auto; margin-right: auto">    
                    <input type="text" name="production" id="production" size="9" maxlength="9">
                    <input type="text" name="fulfillment" id="fulfillment" size="4" maxlength="4">
                </div>    
            </div>
        </div>
        <input type="button" value="Submit" onclick="onShowButtonClick()">
        <table>
            <thead id="garment_info_table_head">
            </thead>
            <tbody id = "garment_info_table_body">
            </tbody>
        </table>
    </body>
</html>